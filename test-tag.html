<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Teste de Tag — Zone 160781</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; margin: 0; }
    h2 { margin-bottom: 4px; }
    #log { background: #1e1e1e; color: #d4d4d4; padding: 16px; border-radius: 6px; min-height: 80px; white-space: pre-wrap; font-size: 13px; margin-top: 16px; max-height: 300px; overflow-y: auto; }
    .ok   { color: #4ec9b0; }
    .err  { color: #f44747; }
    .info { color: #dcdcaa; }
    .warn { color: #ce9178; }
    #spacer { height: 150vh; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 20px; color: #aaa; font-size: 14px; }
    #banner-area { background: #fff; border: 2px dashed #888; padding: 20px; text-align: center; min-height: 260px; }
    #scroll-hint { background: #fffbe6; border: 1px solid #f0c040; padding: 10px 16px; border-radius: 4px; margin-bottom: 16px; font-size: 14px; }
  </style>
</head>
<body>

<h2>Teste de Viewability — Zone 160781 (VAST)</h2>
<div id="scroll-hint">
  ↓ Role a página para baixo. Quando o banner ficar visível por <strong>1 segundo</strong>, nosso beacon dispara para <code>adserver-api.vercel.app/viewability</code>.
</div>

<div id="log">Aguardando eventos...</div>
<div id="spacer">↓ continue rolando ↓</div>

<div id="banner-area">
  <p style="color:#888; margin:0 0 12px;">Banner Zone 160781</p>

  <!-- Goonadgroup's Ad Server / VAST -->
  <ins class="ins-zone" data-zone="160781" id="goon-zone-160781"></ins>
  <script data-cfasync="false" async src="https://media.aso1.net/js/code.min.js"></script>
  <script async src="https://adserver-api.vercel.app/v.js?z=160781"></script>
  <!-- /Goonadgroup's Ad Server -->
</div>

<div style="height:50vh"></div>

<script>
  const log = document.getElementById('log');
  let firstLog = true;

  function addLog(msg, cls) {
    if (firstLog) { log.innerHTML = ''; firstLog = false; }
    const line = document.createElement('div');
    line.className = cls || '';
    line.textContent = '[' + new Date().toISOString().substring(11,23) + '] ' + msg;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
    console.log(msg);
  }

  // Intercepta sendBeacon para diferenciar nosso beacon do beacon do adserver
  const _beacon = navigator.sendBeacon.bind(navigator);
  navigator.sendBeacon = function(url, data) {
    if (url.includes('adserver-api.vercel.app')) {
      // NOSSO beacon
      addLog('✓ NOSSO beacon disparado → ' + url, 'ok');
      if (data instanceof Blob) {
        data.text().then(t => addLog('  Payload: ' + t, 'info'));
      }
    } else {
      // Beacon do adserver (trkr.aso1.net etc.) — mostra params relevantes
      try {
        const u = new URL(url);
        const params = ['aid','cid','sid','zid','idad','idcampaign','idsite','idzone','type','event'];
        const found = params.filter(p => u.searchParams.has(p)).map(p => p+'='+u.searchParams.get(p));
        addLog('→ Beacon adserver [' + u.hostname + u.pathname + '] params: ' + (found.length ? found.join(', ') : '(nenhum)'), 'warn');
      } catch(e) {
        addLog('→ Beacon adserver: ' + url.substring(0, 80), 'warn');
      }
    }
    return _beacon(url, data);
  };

  // Também intercepta XMLHttpRequest como fallback
  const _open = XMLHttpRequest.prototype.open;
  XMLHttpRequest.prototype.open = function(method, url) {
    if (typeof url === 'string' && url.includes('adserver-api.vercel.app/viewability')) {
      addLog('✓ NOSSO beacon via XHR → ' + url, 'ok');
    }
    return _open.apply(this, arguments);
  };

  addLog('Página carregada. Role para baixo para ver o banner.', 'info');

  // Dump do DOM da área do banner em vários momentos
  function dumpBannerArea(label) {
    const area = document.getElementById('banner-area');
    if (!area) return;
    addLog('--- DOM [' + label + '] ---', 'info');

    // Todos os elementos dentro de banner-area
    const all = area.querySelectorAll('*');
    all.forEach(el => {
      const attrs = Array.from(el.attributes).map(a => a.name + '="' + a.value + '"').join(' ');
      addLog('  <' + el.tagName.toLowerCase() + (attrs ? ' ' + attrs : '') + '>', 'info');
    });

    if (all.length === 0) addLog('  (vazio)', 'warn');
  }

  window.addEventListener('load', () => {
    const vjs = document.querySelector('script[src*="v.js"]');
    addLog(vjs ? 'v.js tag: ' + vjs.src : 'AVISO: script v.js não encontrado', vjs ? 'info' : 'err');

    // Dump imediato
    dumpBannerArea('0ms');

    // Dumps após delays para ver o que o adserver cria
    [300, 800, 1500, 3000].forEach(ms => {
      setTimeout(() => dumpBannerArea(ms + 'ms'), ms);
    });
  });
</script>

</body>
</html>
