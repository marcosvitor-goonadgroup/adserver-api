<!--
  INSTRUÇÃO DE USO:
  1. Substitua YOUR_API_URL pela URL da sua API no Vercel (ex: https://api-adserver.vercel.app)
  2. O data-zone já está preenchido com o ID da zona — troque se necessário
  3. Cole no lugar da tag original do adserver
-->

<!-- Goonadgroup's Ad Server / Banner / 300x250 -->
<ins class="ins-zone" data-zone="160272" id="goon-zone-160272"></ins>
<script data-cfasync="false" async src="https://media.aso1.net/js/code.min.js"></script>
<script>
(function () {
  var BEACON_URL = 'YOUR_API_URL/viewability'; // <- substitua
  var THRESHOLD  = 0.5;   // 50% visível (critério IAB display)
  var MIN_MS     = 1000;  // 1 segundo contínuo (critério IAB display)

  var el = document.getElementById('goon-zone-160272');
  if (!el || !window.IntersectionObserver) return;

  var timer     = null;
  var startTime = null;
  var fired     = false;

  function send(viewed, visiblePct, elapsedMs) {
    if (fired) return;
    fired = true;
    var payload = JSON.stringify({
      zone:        el.getAttribute('data-zone'),
      url:         location.href,
      viewed:      viewed,
      visible_pct: Math.round(visiblePct * 100),
      elapsed_ms:  elapsedMs,
      ts:          new Date().toISOString(),
    });
    if (navigator.sendBeacon) {
      var blob = new Blob([payload], { type: 'application/json' });
      navigator.sendBeacon(BEACON_URL, blob);
    } else {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', BEACON_URL, true);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.send(payload);
    }
  }

  var observer = new IntersectionObserver(function (entries) {
    var entry = entries[0];
    if (entry.isIntersecting && entry.intersectionRatio >= THRESHOLD) {
      if (!timer) {
        startTime = Date.now();
        timer = setTimeout(function () {
          send(true, entry.intersectionRatio, Date.now() - startTime);
        }, MIN_MS);
      }
    } else {
      if (timer) {
        clearTimeout(timer);
        timer = null;
        // saiu antes de 1s → não viewable, mas registra se quiser
        // send(false, entry.intersectionRatio, Date.now() - startTime);
      }
    }
  }, { threshold: [0, THRESHOLD, 1] });

  // O adserver carrega o <ins> de forma async — aguarda o iframe/img ser inserido
  var mutationTimer = setInterval(function () {
    if (el.children.length > 0 || el.innerHTML.trim() !== '') {
      clearInterval(mutationTimer);
      observer.observe(el);
    }
  }, 200);

  // Fallback: observa após 3s mesmo sem conteúdo detectado
  setTimeout(function () {
    clearInterval(mutationTimer);
    observer.observe(el);
  }, 3000);
})();
</script>
<!-- /Goonadgroup's Ad Server -->
